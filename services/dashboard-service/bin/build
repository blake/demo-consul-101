#!/usr/bin/env sh

set -e

APPNAME=$(basename "${PWD}")

# OS and architecture of the build machine
BUILDOS=${BUILDOS:-linux}
BUILDARCH=${BUILDARCH:-amd64}

# Target OS and architecture
TARGETOS=${TARGETOS:-linux}
TARGETARCH=${TARGETARCH:-amd64}

# Bundle web assets
echo "Bundling web assets..."
rice embed-go

# Build version for target OS
echo "Building ${TARGETOS}..."
GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -v .
mkdir -p "dist/${TARGETOS}-${TARGETARCH}"
mv "$APPNAME" "dist/${TARGETOS}-${TARGETARCH}/"
cd "dist/${TARGETOS}-${TARGETARCH}" || exit
zip "${APPNAME}.zip" "$APPNAME"
cd ../../

# Build for local platform
echo "Building ${BUILDOS}..."
GOOS=${BUILDOS} GOARCH=${BUILDARCH} go build -v .
mkdir -p "dist/${BUILDOS}-${BUILDARCH}"
mv "$APPNAME" "dist/${BUILDOS}-${BUILDARCH}/"
cd "dist/${BUILDOS}-${BUILDARCH}" || exit
zip "${APPNAME}.zip" "$APPNAME"
cd ../../
